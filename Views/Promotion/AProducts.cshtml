
@using System.Data
@using System.Collections
@using b2b_solution.Models

@{
    DataModel dm = new DataModel();
    DataTable dt = ViewBag.AProducts;
    foreach (DataRow dx in dt.Rows)
    {

        <div class="col-lg-1-5 col-md-4 col-12 col-sm-6">
            <div class="product-cart-wrap mb-30 wow animate__animated animate__fadeIn" data-wow-delay=".1s">
                <div class="product-img-action-wrap">
                    <div class="product-img product-img-zoom">
                        <a href="#">
                            <img class="default-img" src="@dx["itm_Image"].ToString()" alt="" />
                            <img class="hover-img" src="@dx["itm_Image"].ToString()" alt="" />
                        </a>
                    </div>
                    <div class="product-action-1">
                        @*<a aria-label="Add To Wishlist" class="action-btn" onclick="InsWishList(' @dx["itm_ID"].ToString() ')" ><i class=" fi-rs-heart"></i></a>*@
                        @*<a aria-label="Quick view" class="action-btn" data-bs-toggle="modal" data-bs-target="#quickViewModal"><i class="fi-rs-eye"></i></a>*@
                    </div>
                    @*<div class="product-badges product-badges-position product-badges-mrg">
                            <span class="hot">Hot</span>
                        </div>*@
                </div>
                <div class="product-content-wrap">
                    <div class="product-category">
                        <a>@dx["sct_Name"].ToString()</a>
                    </div>
                    <h2><a>@dx["itm_Name"].ToString()</a></h2>

                    <div class="product-card-bottom">
                        <div class="col-lg-6">
                            <div class="header-info header-info">
                                <ul>
                                    <li>

                                        @{
                                            DataTable dtUom = dm.loadList("SelItemHigherUOM", "sp_B2B_Home", @dx["itm_ID"].ToString());
                                            List<SelectListItem> list = new List<SelectListItem>();
                                            foreach (DataRow drUom in dtUom.Rows as IEnumerable)
                                            {
                                                list.Add(new SelectListItem { Text = drUom["uom_Name"].ToString(), Value = drUom["uom_ID"].ToString() });
                                            }
                                        }

                                        @Html.DropDownList("uomID", new SelectList(list, "Value", "Text", dx["crd_HigherUOM"]), new
                                        {
                                            @class = "language-dropdown",
                                       @onchange = "GetALUOM('" + @dx["itm_ID"].ToString() + "' , this)",
                                            @id = "AHUOM" + @dx["itm_ID"].ToString()
                                   })
                                    </li>
                                </ul>
                            </div>

                            <div class="product-price">
                                <span id="AHOP-@dx["itm_ID"].ToString()">@dx["OfferPrice"].ToString()</span>
                                @{ 
                                    string offerPrice = dx["OfferPrice"].ToString();
                                    string StandardPrice = dx["standardPrice"].ToString();
                                    if (offerPrice == StandardPrice)
                                    {
                                        StandardPrice = "";
                                    }
                                }
                                <span id="AHSP-@dx["itm_ID"].ToString()" class="old-price">@StandardPrice</span>
                            </div>
                        </div>

                        <div class="add-cart">
                            <div class="detail-extralink">
                                @(Html.Kendo().NumericTextBox()
            .Name("AHqty" + @dx["itm_ID"].ToString())
            .Min(0)
            .Format("##")
            .Events(e => e.Change("changeAHQty").Spin("changeAHQty"))
            .Max(90000)
            .Value(int.Parse(@dx["crd_HigherQty"].ToString()) )
            .Step(1)
            .RestrictDecimals(true)
            .HtmlAttributes(new { style = "width: 100%; text-align:center" , @class="form-control"  }) )
                            </div>
                        </div>
                    </div>

                    @*LOWER UOM CONFIGURATION AREA*@

                    @{

                        ViewBag.ProductRow = dx;
                        if (Double.Parse(dx["crd_LowerQty"].ToString()) >= 0)
                        {


                            string[] arr = { dx["itm_ID"].ToString() };
                            DataTable dtLowerUom = dm.loadList("SelItemLowerUOM", "sp_B2B_Home", dx["crd_HigherUOM"].ToString(), arr);

                            List<UOMModel> transaction_Lists = new List<UOMModel>();
                            foreach (DataRow drUom in dtLowerUom.Rows as IEnumerable)
                            {
                                transaction_Lists.Add(new UOMModel { Text = drUom["uom_Name"].ToString(), Value = drUom["uom_ID"].ToString() });
                            }

                            var uomLow = new UomList();
                            uomLow.ListUomModel = transaction_Lists;

                            List<ItemRow> RowItems = new List<ItemRow>();
                            RowItems.Add(new ItemRow
                            {
                                id = dx["itm_ID"].ToString(),
                                LowerUOM = dx["crd_lowerUOM"].ToString(),
                                LowerUOMOfferPrice = dx["LowerOfferPrice"].ToString(),
                                LowerUOMStandardPrice = dx["LowerStdPrice"].ToString(),
                                lowerQty = dx["crd_LowerQty"].ToString()
                            });

                            var LowRow = new ItemList();
                            LowRow.Rowitem = RowItems;

                            <div id="AlowPartial-@dx["itm_ID"]" class="fadeIn">
                                @{
                                    if (dtLowerUom.Rows.Count > 0)
                                    { @Html.Partial("ALowerUOM", new ProductList { LowItem = LowRow, LowUOM = uomLow })}
                                }


                            </div>


                        }
                    }




                </div>

            </div>
        </div>



        <div class="modal fade custom-modal" id="FailureRes" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <div class="modal-body">
                        <div class="timeline">
                            <div class="col-lg-12">
                                <div class="form-group">
                                    <h4 style="color:red">
                                       You have exceed the limit for the eligibility count, please check again
                                        <img height="40" src="../Content/imgs/order/sad.png" />
                                    </h4>
                                </div>

                                <div class="form-group" style="margin-top: 25px; text-align-last:end">
                                    <button style="background-color:lightcoral" onclick="DismissModelRes()" class="btn btn-secondary ">OK</button>

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



    }

    <style>
        .k-select {
            background-color: #ffffff;
            border-color: #d32027 !important;
            color: #d32027 !important;
            border-style: hidden !important;
        }

        .k-link-increase {
            height: 25px !important;
        }

        .k-link-decrease {
            height: 25px !important;
        }

        .k-state-default {
            border-color: #d32027 !important;
        }
    </style>
    <script>

        function GetALUOM(id, itmValue) {
            debugger;
            var uomID = itmValue.value;
            $.ajax({
            type: "GET",
            url: '@Url.Action("GetItemUOMPrice", "Home")',
            contentType: "application/json; charset=utf-8",
                data: { id: id, itmValues: uomID },
            dataType: "json",
                success: function (data) {
                    document.getElementById("AHOP-" + id).innerHTML = data.OfferPrice;
                    document.getElementById("AHSP-" + id).innerHTML = data.StandardPrice;
                }

            });

             $.ajax({
            type: "GET",
            url: '@Url.Action("UpdateHUOMCart", "Home")',
            contentType: "application/json; charset=utf-8",
                data: { id: id, itmValues: uomID },
            dataType: "json"
            });

            $('#AlowPartial-' + id).load('/Home/GetALowerUOM?id=' + id + "&&itmValues=" + uomID);
        }

        function changeAHQty() {
            var AQCount = parseInt( document.getElementById("AQCount").innerHTML);
            var ACount = parseInt( document.getElementById("ACount").innerHTML);
             var x = this;

                var id = x.element.attr("id");
                var itemID = id.replace("AHqty", "");
                var HUom = $('#AHUOM' + itemID).val();
                var LQty = $('#ALQTY-' + itemID).val();

                if (LQty == null) {
                    LQty = 0;
                }
                var LUOM = $('#AddlUOM-' + itemID).val();
                if (LUOM == null) {
                    LUOM = 0;
                }




                $.ajax({
                    type: "GET",
                    url: '@Url.Action("InsPromoCart", "Promotion")',
                    contentType: "application/json; charset=utf-8",
                    data: {
                        "id": itemID,
                        "HigherQty": x.value(),
                        "HigherUOM": HUom,
                        "LowerQty": LQty,
                        "LowerUOM": LUOM,
                        "prmID": @ViewBag.prmID,
                        "ashID": @ViewBag.ashID
                 },

                    dataType: "json",
                    success: function (data) {
                        if (data == "Exceeded") {
                            ShowModelRes();
                        }

                    }
                });

                GetTotAssgQty();


        }



        function DismissModelRes() {
            document.location.reload(true);
        }

        function ShowModelRes() {
            $('#FailureRes').modal('show');
        }


    function GetALUOMPrice(id, itmValue) {
            var uomID = itmValue.value;

            $.ajax({
            type: "GET",
            url: '@Url.Action("GetItemUOMPrice", "Home")',
            contentType: "application/json; charset=utf-8",
                data: { id: id, itmValues: uomID },
            dataType: "json",
                success: function (data) {


                    document.getElementById("ALOP-" + id).innerHTML = data.OfferPrice;
                    document.getElementById("ALSP-" + id).innerHTML = data.StandardPrice;
                }
            });
          $.ajax({
            type: "GET",
            url: '@Url.Action("UpdateLUOMPromoCart", "Promotion")',
            contentType: "application/json; charset=utf-8",
              data: {
                  "id": id,
                  "LowerUOM": uomID,
                     "prmID": @ViewBag.prmID,
                     "ashID": @ViewBag.ashID

              },
            dataType: "json"
          });

    }


        function changeALQty() {
            var AQCount = parseInt(document.getElementById("AQCount").innerHTML);
            var ACount = parseInt(document.getElementById("ACount").innerHTML);

                var x = this;

                var id = x.element.attr("id");
                var itemID = id.replace("ALQTY-", "");
                var HUom = $('#AHUOM' + itemID).val();
                var Hqty = $('#AHqty' + itemID).val();

                if (Hqty == null) {
                    Hqty = 0;
                }
                var LUOM = $('#AddlUOM-' + itemID).val();
                if (LUOM == null) {
                    LUOM = 0;
                }


                $.ajax({
                    type: "GET",
                    url: '@Url.Action("InsPromoCart", "Promotion")',
                    contentType: "application/json; charset=utf-8",
                    data: {
                        "id": itemID,
                        "HigherQty": Hqty,
                        "HigherUOM": HUom,
                        "LowerQty": x.value(),
                        "LowerUOM": LUOM,
                        "prmID": @ViewBag.prmID,
                        "ashID": @ViewBag.ashID
                 },

                    dataType: "json",
                    success: function (data) {
                        if (data == "Exceeded") {
                            ShowModelRes();
                           
                        }
                    }
                });
                UpdCartCount();
                GetTotAssgQty();

        }




    </script>
}

