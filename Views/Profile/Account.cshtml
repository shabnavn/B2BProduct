@using System.Data;
@using b2b_solution.Models;
@using System.Collections.Generic
@using System.Collections

@{
    ViewBag.Title = "Account";
    Layout = "~/Views/Shared/_Layout.cshtml";
    DataModel dm = new DataModel();
    string Roles = Session["Roles"].ToString();

    

}
}
<main class="main pages">

    <div class="page-content pt-50 pb-50">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 m-auto">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="dashboard-menu">
                                <ul class="nav flex-column" role="tablist">
                                    <li class="nav-item">
                                        <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard"
                                           role="tab" aria-controls="dashboard" aria-selected="false"><i class="fi-rs-user mr-10"></i>Profile</a>
                                    </li>
                                    <li class="nav-item" hidden>
                                        <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab"
                                           aria-controls="address" aria-selected="true"><i class="fi-rs-marker mr-10"></i>My Address</a>
                                    </li>

                                    @{
                                        if (Roles.Contains("AD"))
                                        {
                                            <li class="nav-item">
                                                <a class="nav-link" id="newuser-tab" data-bs-toggle="tab" href="#newuser" role="tab"
                                                   aria-controls="newuser" aria-selected="true"><i class="fi-rs-user-add mr-10"></i>Users</a>
                                            </li>
                                        }
                                    }


                                    <li class="nav-item">
                                        <a class="nav-link" id="cpassword-tab" data-bs-toggle="tab" href="#cpassword" role="tab"
                                           aria-controls="cpassword" aria-selected="true"><i class="fi-rs-password mr-10"></i>Change Password</a>
                                    </li>
                                    <li class="nav-item" hidden="hidden">
                                        <a class="nav-link" href="/Dashboard/ViewAll"><i class="fi-rs-dashboard mr-10"></i>Customer Dashboard</a>
                                    </li>

                                    <li class="nav-item">
                                        <a class="nav-link" href="/Landing/Login"><i class="fi-rs-sign-out mr-10"></i>Logout</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="col-md-9">
                            <div class="tab-content account dashboard-content pl-50">
                                <div class="tab-pane fade active show" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="mb-0">Hello  @Session["UserName"].ToString()</h3>
                                        </div>
                                        <div class="card-body">
                                            <div>

                                                @{


                                                    DataTable dtUserInfo = dm.loadList("SelUser", "sp_B2B_Profile", Session["userID"].ToString());
                                                    DataTable dtCusInfo = dm.loadList("SelCus", "sp_B2B_Profile", Session["CusID"].ToString());
                                                }

                                                <div class="row">
                                                    <div class="form-group col-md-6">
                                                        <label>Email Address</label>
                                                        <p style="font-weight:bold"> @dtUserInfo.Rows[0]["Email"].ToString() </p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Mobile Number </label>
                                                        <p style="font-weight:bold"> @dtUserInfo.Rows[0]["MobileNumber"].ToString() </p>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="form-group col-md-6">
                                                        <label>Customer Name</label>
                                                        <p style="font-weight:bold; display:grid">
                                                            <span>@dtCusInfo.Rows[0]["csh_Name"].ToString()</span>
                                                            <span>@dtCusInfo.Rows[0]["cus_Name"].ToString()</span>

                                                        </p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Customer Code</label>
                                                        <p style="font-weight:bold"> @dtCusInfo.Rows[0]["cus_Code"].ToString() </p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Total Credit Limit </label>
                                                        <p style="font-weight:bold">@dtCusInfo.Rows[0]["cus_TotalCredit"].ToString()</p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Used Credit Limit </label>
                                                        <p style="font-weight:bold">@dtCusInfo.Rows[0]["cus_UsedCredit"].ToString()</p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Available Credit Limit </label>
                                                        <p style="font-weight:bold">@dtCusInfo.Rows[0]["cus_AvailableCredit"].ToString()</p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Credit Days </label>
                                                        <p style="font-weight:bold">@dtCusInfo.Rows[0]["cus_CreditDays"].ToString()</p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Roles </label>
                                                        <p style="font-weight:bold">@Session["RoleName"].ToString().Substring(0, @Session["RoleName"].ToString().Length - 1)</p>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label>Currency </label>
                                                        <p style="font-weight:bold">@dtCusInfo.Rows[0]["cus_Currency"].ToString()</p>
                                                    </div>

                                                    @{
                                                        if (Roles.Contains("AD") || Roles.Contains("OT"))
                                                        {

                                                        }
                                                        else
                                                        {
                                                            <div class="section-title style-2 wow animate__animated animate__fadeIn fs-6">
                                                                <span>  Finance users do not have the permission to place an order.</span>
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="row">
                                        <div class="col-lg-6">
                                            <div class="card mb-3 mb-lg-0">
                                                <div class="card-header">
                                                    <h3 class="mb-0">Billing Address</h3>
                                                </div>
                                                <div class="card-body">
                                                    <address>
                                                        @dtCusInfo.Rows[0]["cus_BuildingName"].ToString() , @dtCusInfo.Rows[0]["cus_RoomNo"].ToString()  <br />
                                                        @dtCusInfo.Rows[0]["cus_Street"].ToString() ,<br />
                                                        @dtCusInfo.Rows[0]["cus_LandMark"].ToString(). <br />
                                                    </address>
                                                    <p>@dtCusInfo.Rows[0]["sta_Name"].ToString()</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-12 row mb-10">
                                            <div class="card">
                                                <div class="card-header" style="display:flex">
                                                    <h5 class="mb-0">Shipping Address</h5>  <a href=" javascript:AddNew() " style="margin-left:10px; background-color:orange;  border-radius:10px; line-height:0"
                                                                                               class="btn btn-small">Add New</a>
                                                </div>
                                                <div class="col-lg-12 row card-body">
                                                    @{
                                                        DataTable dtUserAddress = dm.loadList("SelUserAddress", "sp_B2B_Profile", Session["userID"].ToString());
                                                        if (dtUserAddress.Rows.Count > 0)
                                                        {
                                                            foreach (DataRow dr in dtUserAddress.Rows)
                                                            {
                                                                <div class="col-lg-6 border mb-10 p-10">
                                                                    <address>
                                                                        @dr["cua_BuldgName"].ToString() , @dr["cua_RoomNo"].ToString()  <br />
                                                                        @dr["cua_Street"].ToString() ,<br />
                                                                        @dr["cua_LandMark"].ToString(). <br />
                                                                    </address>

                                                                    <p>@dr["sta_Name"].ToString()</p>
                                                                    <div style="display:flex">
                                                                        <a href="javascript: DeleteReq(@dr["cua_ID"])" class="btn-small mr-5">
                                                                            <img height="30" src="~/Content/imgs/profile/delete.png" alt="delete" />
                                                                        </a>

                                                                        @{
                                                                            if (@dr["cua_IsDefault"].ToString().Equals("Y"))
                                                                            {

                                                                                <label class="btn btn-info ml-10"
                                                                                       style="background-color: white; color: #279115;  padding: 5px; border-color: brown ">Default</label>
                                                                            }
                                                                            else
                                                                            {
                                                                                <a href="javascript:SetDefault(@dr["cua_ID"]) "
                                                                                   style="background-color: white; color: black; border-color: brown "
                                                                                   class="btn btn-small ml-10">Make as Default</a>
                                                                            }
                                                                        }

                                                                    </div>

                                                                    <div id="delSec-@dr["cua_ID"]" style="display:none" class="modal-dialog">
                                                                        <div class="modal-content" style="padding:0px">
                                                                            <div class="modal-body">
                                                                                <div class="timeline">
                                                                                    <div class="col-lg-12">
                                                                                        <div class="form-group">
                                                                                            <h6> Are you sure, you want to delete this address?</h6>
                                                                                        </div>
                                                                                        <div class="form-group" style="margin-top: 25px; text-align-last:end">
                                                                                            <button style="background-color:lightcoral" onclick="DelProceed(@dr["cua_ID"])" class="btn btn-primary ">Yes</button>
                                                                                            <button onclick="DeleteReqDis(@dr["cua_ID"])" class="btn btn-danger ">No</button>

                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>


                                                                </div>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            <p>No Shipping Address Found... </p>
                                                        }

                                                    }
                                                </div>



                                            </div>
                                        </div>

                                        <div id="NewAddress" style="display:none">
                                            <div class="card-header mb-10">
                                                <h5 class="mb-0">Add Shipping Address</h5>
                                            </div>

                                            <div class="row">
                                                <div class="form-group col-lg-6">
                                                    <input type="text" id="bldgName" autocomplete="off" name="building" placeholder="Building Name*">
                                                    <label id="lblbldgname" style="color:red; font-size:small"></label>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <input type="text" id="roomNo" required="" autocomplete="off" name="room" placeholder="Room No*">
                                                    <label id="lblroomNo" style="color:red; font-size:small"></label>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="form-group col-lg-6">
                                                    <input type="text" name="street" id="street" autocomplete="off" required="" placeholder="Street*">
                                                    <label id="lblstreet" style="color:red; font-size:small"></label>
                                                </div>
                                                <div class="form-group col-lg-6">
                                                    <input type="text" name="landmark" id="landmark" autocomplete="off" required="" placeholder="Landmark">
                                                </div>
                                            </div>
                                            <div class="row shipping_calculator">
                                                <div class="form-group col-lg-6">
                                                    <div class="custom_select" style="width:100%">
                                                        @{
                                                            DataTable dt = dm.loadList("SelEmirate", "sp_B2B_Home");
                                                            List<SelectListItem> list = new List<SelectListItem>();
                                                            foreach (DataRow dr in dt.Rows as IEnumerable)
                                                            {
                                                                list.Add(new SelectListItem { Text = dr["Name"].ToString(), Value = dr["id"].ToString() });
                                                            }
                                                            int catCount = 6;
                                                        }

                                                        @Html.DropDownList("catID", new SelectList(list, "Value", "Text", 1), "Select Emirate", new { @class = "select-active", @id = "Emirate" })

                                                    </div>
                                                </div>
                                                <div class="form-group col-lg-6" style="text-align:end">
                                                    <a href=" javascript:CancelAddr() " class="btn btn-danger" style="background-color:orangered">Cancel</a>
                                                    <a href=" javascript:SaveAddr(1) " class="btn btn-outline-success">Add</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="newuser" role="tabpanel" aria-labelledby="address-tab">
                                    <div class="row">
                                        @{
                                            Html.RenderPartial("UserProfiles");
                                        }
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="cpassword" role="tabpanel" aria-labelledby="account-detail-tab">
                                    <div class="card">
                                        <div class="card-header">
                                            <h5>Change Password..</h5>
                                        </div>
                                        <div class="card-body ">
                                            <div name="frm">
                                                <div class="row col-lg-6">

                                                    <div class="form-group col-md-12">
                                                        <label>User Name <span class="required">*</span></label>
                                                        <input required="" value=" @dtUserInfo.Rows[0]["UserName"].ToString()" class="form-control" disabled="disabled" />
                                                    </div>
                                                    <label>Current Password <span class="required">*</span></label>
                                                    <div class="form-group col-md-12" style="display:flex">

                                                        <input required="" id="cpass" class="form-control" name="password" type="password" />
                                                        <span class="">
                                                            <i class=" fi-rs-eye-crossed " style=" margin-left: -20px; margin-top: 20px; position: absolute; " id="cpassToggle" onclick="PasswordVisibility('cpass' , 'cpassToggle')"></i>
                                                        </span>
                                                        <label id="lblcpass" style="display:none; color:red; font-size:small"></label>
                                                    </div>

                                                    <label>New Password <span class="required">*</span></label>
                                                    <div class="form-group col-md-12" style="display:flex">

                                                        <input required="" id="npass" type="password" class="form-control" name="new" />
                                                        <span class="">
                                                            <i class=" fi-rs-eye-crossed " style=" margin-left: -20px; margin-top: 20px; position: absolute; " id="npassToggle" onclick="PasswordVisibility('npass' , 'npassToggle')"></i>
                                                        </span>

                                                        <label id="lblnpass" style="color: red; display: none; font-size: small"></label>
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <label>Confirm Password <span class="required">*</span></label>
                                                        <input required="" id="cnpass" class="form-control" name="confirm" type="password" />
                                                        <label id="lblcnpass" style="color: red; display: none; font-size: small"></label>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <label id="lblSmes" style="color: green; display: none; font-size: small"></label>
                                                        <button type="submit" onclick="UpdPass('@dtUserInfo.Rows[0]["UserName"].ToString()')"
                                                                class="btn btn-fill-out submit font-weight-bold"
                                                                name="submit">
                                                            Update Password
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>



<div class="modal fade custom-modal" id="DelModal" tabindex="-1" aria-labelledby="quickViewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="padding:0px">
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            <div class="modal-body">
                <div class="timeline">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <h4> Are you sure, you want to delete this address?</h4>
                        </div>
                        <div class="form-group" style="margin-top: 25px; text-align-last:end">
                            <button style="background-color:lightcoral" onclick="DismissSuccess()" class="btn btn-primary ">Yes</button>
                            <button data-dismiss="modal" class="btn btn-danger ">No</button>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>

    $(document).ready(function () {
        const params = new URLSearchParams(window.location.search);
        var md = params.get('mode');

        if (md == "address") {
            let addr = document.getElementById('address');
            let addrTab = document.getElementById('address-tab');

            let prof = document.getElementById('dashboard');
            let profTab = document.getElementById('dashboard-tab');

            prof.classList.remove('active', 'show');
            profTab.classList.remove('active');

            addr.classList.add('active', 'show');
            addrTab.classList.add('active');
        }
        else if (md == "password") {
            let addr = document.getElementById('cpassword');
            let addrTab = document.getElementById('cpassword-tab');

            let prof = document.getElementById('dashboard');
            let profTab = document.getElementById('dashboard-tab');

            prof.classList.remove('active', 'show');
            profTab.classList.remove('active');

            addr.classList.add('active', 'show');
            addrTab.classList.add('active');
        }
    });

    function DeleteReq(cuaID) {
        $('#delSec-' + cuaID).show();
    }


    function EditReq(cuaID , bldg, roomNo , street, landmark, emirate) {
        document.getElementById("bldgName").value = bldg;
        document.getElementById("roomNo").value = roomNo;
        document.getElementById("street").value = street;
        document.getElementById("landmark").value = landmark;
        //document.getElementById("landmark").value = emirate;
        $('#NewAddress').show();
    }

    function DeleteReqDis(cuaID) {
        $('#delSec-' + cuaID).hide();
    }

    function AddNew() {
        $('#NewAddress').show();
    }

    function SaveAddr(mode) {
        var x = ValidateControls();
        if (x) {

            var BuildingName = document.getElementById("bldgName").value;
            var RoomNo = document.getElementById("roomNo").value;
            var Street = document.getElementById("street").value;
            var LandMark = document.getElementById("landmark").value;
            var Emirate = document.getElementById("Emirate").value;

            $.ajax({
                type: "GET",
                url: '@Url.Action("AddNewAddr", "Profile")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "BuldgName": BuildingName,
                    "RoomNo": RoomNo,
                    "Street": Street,
                    "LandMark": LandMark,
                    "State": Emirate
                },
                dataType: "json",
                success: function (data) {
                    if (data.mode == 1) {
                       window.location.href = '/profile/Account?mode=address';
                    } else {
                        alert('We are facing some technical issues now, please try again later')
                    }
                }
            });
        }
    }

    function DelProceed(cuaID) {
         $.ajax({
                type: "GET",
                url: '@Url.Action("DelAddr", "Profile")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "cuaID": cuaID
                },
                dataType: "json",
                success: function (data) {
                    if (data.mode == 1) {
                        window.location.href = '/profile/Account?mode=address';
                    } else {
                        alert('We are facing some technical issues now, please try again later')
                    }
                }
            });
    }

      function CancelAddr() {
          document.getElementById("bldgName").value = "";
          document.getElementById("roomNo").value = "";
          document.getElementById("street").value = "";
          document.getElementById("landmark").value = "";
          $('#NewAddress').hide();
    }


    function ValidateControls() {
        var valCount = 0;
        if (document.getElementById("bldgName").value == "") {
            valCount++;
            document.getElementById("lblbldgname").innerHTML = "Please enter building details";
        } else {
            document.getElementById("lblbldgname").innerHTML = "";
        }

        if (document.getElementById("roomNo").value == "") {
            valCount++;
            document.getElementById("lblroomNo").innerHTML = "Please enter room details";
        } else {
            document.getElementById("lblroomNo").innerHTML = "";
        }

        if (document.getElementById("street").value == "") {
            valCount++;
            document.getElementById("lblstreet").innerHTML = "Please enter street";
        } else {
            document.getElementById("lblstreet").innerHTML = "";
        }

        if (valCount > 0) {
            return false;
        } else {
            return true;
        }
    }

    function UpdPass(userName) {
        var y = ValidatePass();
        if (y) {
            var cPass = document.getElementById("cpass").value;
            var nPass = document.getElementById("npass").value;

            $.ajax({
                type: "GET",
                url: '@Url.Action("UpdPassword", "Profile")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "cPass": cPass,
                    "nPass": nPass,
                    "uName": userName
                },
                dataType: "json",
                success: function (data) {
                    if (data.mode == 1) {
                        document.getElementById("lblSmes").innerHTML = "Password updated successfully";
                        document.getElementById("cpass").value = "";
                        document.getElementById("npass").value = "";
                        document.getElementById("cnpass").value = "";
                        document.getElementById('lblSmes').style.display = 'block';

                    } else {
                        document.getElementById("lblcnpass").innerHTML = "Your old password is wrong, please try again";
                        document.getElementById('lblcnpass').style.display = 'block';
                        document.getElementById("lblSmes").innerHTML = "";
                    }
                }
            });
        }
    }

    function ValidatePass() {
        var valCount1 = 0;
        if (document.getElementById("cpass").value == "") {
            valCount1++;
            document.getElementById("lblcpass").innerHTML = "Please enter current password";
            document.getElementById('lblcpass').style.display = 'block';
        } else {
            document.getElementById("lblcpass").innerHTML = "";
        }

        if (document.getElementById("npass").value == "") {
            valCount1++;
            document.getElementById("lblnpass").innerHTML = "Please enter new password";
            document.getElementById('lblnpass').style.display = 'block';
        } else {
            document.getElementById("lblnpass").innerHTML = "";
        }

        if (document.getElementById("cnpass").value == "") {
            valCount1++;
            document.getElementById("lblcnpass").innerHTML = "Please enter confirm password";
            document.getElementById('lblcnpass').style.display = 'block';
        } else {
            if (document.getElementById("cnpass").value != document.getElementById("npass").value) {
                valCount1++;
                document.getElementById("lblcnpass").innerHTML = "New password and confirm password not matching";
                document.getElementById('lblcnpass').style.display = 'block';
            } else {
                document.getElementById("lblcnpass").innerHTML = "";
            }
        }



        if (valCount1 > 0) {
            return false;
        } else {
            return true;
        }
    }

    function SetDefault(cuaID) {
        $.ajax({
                type: "GET",
                url: '@Url.Action("SetDefault", "Profile")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "cuaID": cuaID
                },
                dataType: "json",
                success: function (data) {
                    if (data.mode == 1) {
                        window.location.href = '/profile/Account?mode=address';
                    } else {
                        alert('We are facing some technical issues now, please try again later')
                    }
                }
            });
    }

</script>

<script>
    // Retrieve the selected customer ID from sessionStorage
    var selectedCustomerId = sessionStorage.getItem("selectedCustomerId");

    // Use the selectedCustomerId as needed
    console.log("Selected Customer ID: " + selectedCustomerId);

    // Now, you can use selectedCustomerId in your Razor code
</script>

<style>
    .shipping_calculator .custom_select .select2-container {
        width: 100% !important
    }
</style>

