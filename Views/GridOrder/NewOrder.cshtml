@using b2b_solution.Models;

@{

    ViewBag.Title = "NewOrder";
    Layout = "~/Views/Shared/_GridLayout.cshtml";
}

<div class="d-flex flex-column flex-column-fluid">
    <!--begin::Toolbar-->
    <div id="kt_app_toolbar" class="app-toolbar py-3 py-lg-6">
        <!--begin::Toolbar container-->
        <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex flex-stack">
            <!--begin::Page title-->
            <div class="page-title d-flex  flex-wrap me-3">
                <!--begin::Title-->
                <a href="/Home/Index">
                    <span style="padding-right: 10px">
                        <img src="../Content/GridContent/media/icons/left-arrow.svg" />
                    </span>
                </a>

                <h1 class="page-heading d-flex text-dark fw-bold fs-3 flex-column justify-content-center my-0">
                    New Order
                </h1>

                <!--end::Title-->
            </div>
            <!--end::Page title-->
            
                <!--begin::Nav-->
                <div class="nav d-flex justify-content-between mb-3  mx-9 " style=" display: grid !important">

                    @{
                        if (@Session["cusHeader"].ToString() == @Session["cusName"].ToString())
                        {
                            <span class="lable ml-0 text-to-wrap title "> @Session["cusHeader"].ToString() </span>
                            <span class="lable ml-0 text-to-wrap">  </span>
                        }
                        else
                        {
                            <span class="lable ml-0 text-to-wrap title"> @Session["cusHeader"].ToString() </span>
                            <span class="lable ml-0 text-to-wrap title"> @Session["cusName"].ToString() </span>
                        }
                    }

                </div>


            
            <!--begin::Actions-->
            <div class="d-flex align-items-center gap-2 gap-lg-3">
                <a href="#" class="btn btn-outline btn-sm  " style="outline:auto !important; display:none">Back</a>
                <a href="/Home/Index" class="btn btn-sm fw-bold btn-outline btn-color-gray-700" tabindex="10">Cancel</a>
                <a href="#" onclick="CreateOrder()" class="btn btn-sm fw-bold btn-primary" tabindex="10">Proceed</a>
                <img id="loaderFG" style="display:none" class="text-center" src="../Content/GridContent/media/icons/loader.gif" height="38" />
                <!--begin::Secondary button-->
                <!--end::Secondary button-->
                <!--begin::Primary button-->
                <!--end::Primary button-->
            </div>
            <!--end::Actions-->
        </div>
        <!--end::Toolbar container-->
    </div>
    <!--end::Toolbar-->
    <!--begin::Content-->
    <div id="kt_app_content" class="app-content flex-column-fluid">
        <!--begin::Content container-->
        <div id="kt_app_content_container" class="app-container container-fluid">
            <!--begin::Row-->


            <div class="row g-5 g-xl-10 mb-5 mb-xl-10">
                <!--begin::Col-->
                <div class="col-xl-6 card card-flush ">
                    <!--begin::Chart Widget 35-->
                    <div class="col-lg-12 row mb-3" style="display: -webkit-box;">
                        <!--begin::Header-->
                        <div class="col-lg-12">
                            <div class="col-lg-12 pt-5 ">
                                <!--begin::Title-->
                                <span class=" align-items-start flex-column">
                                    Select Order Type
                                </span>
                            </div>
                            <div class="row col-lg-12 pt-2">
                                <div class="col-4">
                                    <label class="form-check-image active">
                                        <div class="form-check form-check-custom form-check-solid">
                                            <input class="form-check-input" type="radio" onclick="CusChange()" checked value="1" name="otype" />
                                            <div class="form-check-label">
                                                New Order
                                            </div>
                                        </div>
                                    </label>
                                </div>
                                <!--end::Col-->
                                <!--begin::Col-->
                                <div class="col-4">
                                    <label class="form-check-image active">
                                        <div class="form-check form-check-custom form-check-solid">
                                            <input class="form-check-input" id="repeat" onclick="CusChange()" type="radio" value="2" name="otype" />
                                            <div class="form-check-label">
                                                Repeat Order
                                            </div>

                                        </div>
                                    </label>
                                </div>
                                <div class="col-4">
                                    <ul class="nav d-flex justify-content-between mb-3 " style="width:250px">
                                        @(Html.Kendo().MultiColumnComboBox()
    .Name("PreviousOrders")
    .Placeholder("Select a previous order")
    .DataTextField("OrdNumber")
    .DataValueField("ordID")
    .Filter("contains")
    .FilterFields(new string[] { "OrdNumber", "CreatedOn" })
    .Columns(columns =>
    {
        columns.Add().Field("OrdNumber").Title("Order Number").Width("200px");
        columns.Add().Field("CreatedOn").Title("Created On").Width("100px");
    })
    .HtmlAttributes(new { style = "width: 100%", @class = "form-control", @tabindex = "11" })
    .DataSource(source =>
    {
        source.Read(read =>
        {
            read.Action("getPrevOrders", "GridOrder").Data("RepeatOrder");
        }).ServerFiltering(true);
    })
    .Enable(true)
    .AutoBind(false)
    .CascadeFrom("Customers")
     .Events(e =>
            {
                e.Change("onRepeatChange");
            })
                )


                                        <img id="loaderAll" style="display: none; position: fixed; " src="../Content/media/icons/loader.gif" height="38" />
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!--end::Body-->
                    </div>

                    <!--end::Chart Widget 33-->
                    <div class=" col-lg-12 row" style="display: -webkit-box;">

                    </div>
                    <div class=" col-lg-12 row">
                        <!--begin::Header-->
                        <div class="col-lg-3">
                            <div class="col-lg-12">
                                <span class=" align-items-start flex-column">
                                    LPO
                                </span>
                                <div class="form-group" style="display: flex; align-items: center; margin-bottom: 10px;">
                                    <input type="text" class="form-control" id="LPO" name="lpo" placeholder="Enter LPO" style="margin-right: 10px; height: 30px; ">
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6">
                            <div class="nav d-flex justify-content-between mb-3 ">
                                <div class="form-group"  id="LPOfile">
                                    <div class="form-group">
                                        @(Html.Kendo().Upload()
        .Name("files")
        .Async(a => a
            .Save("Async_Save", "GridOrder")
            .Remove("Async_Remove", "GridOrder")
            .AutoUpload(true)
        ).HtmlAttributes(new { @style="width:100%" })
        .DropZone(null)
        .Multiple(false)
    )
                                        <label id="lblFile" style="color: red; font-size: small; margin-left: 10px;"></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-3" style="align-items:flex-start;">
                            <div class="col-lg-12">

                                <!--begin::Title-->
                                <span class="align-items-start flex-column">
                                    Exp Delivery Date
                                </span>

                                <div class="col-lg-12">

                                    <!--begin::Nav-->
                                    <ul class="nav d-flex justify-content-between mb-3" style="width:100%">
                                        @(Html.Kendo().DatePicker()
          .Name("dspDate")
          .Format("dd-MMM-yyyy")
          .Value(DateTime.Now)
          .Min(DateTime.Now)
          .Max(DateTime.Now.AddDays(10))
          .HtmlAttributes(new { style = "width: 100%", title = "datepicker"  , @tabindex = "2", @class ="form-control" })
        )
                                        @*<span id="dateError" style="color:red; display:none"> Please enter date </span>*@
                                    </ul>
                                </div>
                            </div>
                        </div>


                        <!--<div class="col-lg-4">

    <!--end::Body-->
                    </div>
                    </div>
                    <!--end::Col-->
                    <!--begin::Col-->
                    <div class="col-xl-3 ">
                        <!--begin::Tables widget 14-->
                        <div class="card card-flush h-md-100">


                            <div class="table-responsive" style="padding-left:7%; padding-right:5%; padding-top:2%">
                                <table class="table mb-0">
                                    <tbody>
                                        <tr>
                                            <td class="pb-0">Payment Type</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="PayType"></span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td class="pb-0">Credit Days</td>
                                            <th class="pb-0" style="text-align: end;">

                                                <span id="CreditDays"></span>

                                            </th>
                                        </tr>

                                        <tr>
                                            <td class="pb-0">Total Credit Limit</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="TotCredLimit"></span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td class="pb-0">Used Credit Limit</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="UsedCredLimit"></span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td>Available Credit Limit</td>
                                            <th style="text-align: end;"><span id="AvCreditLimit"></span></th>
                                        </tr>

                                    </tbody>
                                </table>

                                <table class="table">
                                    <tbody>
                                        <tr>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!--end::Tables widget 14-->
                    </div>

                    <div class="col-xl-3 card card-flush" style="width:355px">
                        <!--begin::Tables widget 14-->
                        <div class="card card-flush h-md-100">


                            <div class="table-responsive" style="padding-left:7%; padding-right:5%; padding-top:2%">
                                <table class="table mb-0">
                                    <tbody>
                                        <tr>
                                            <td class="pb-0">Total</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="Summ_Total"></span>

                                            </th>
                                        </tr>
                                        <tr>
                                            <td class="pb-0">Discount</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="Summ_Discount"></span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td class="pb-0">Sub Total</td>
                                            <th class="pb-0" style="text-align: end;">
                                                <span id="Summ_SubTotal"></span>
                                            </th>
                                        </tr>
                                        <tr>
                                            <td>VAT</td>
                                            <th style="text-align: end;"><span id="Summ_VAT"></span></th>
                                        </tr>

                                    </tbody>

                                </table>
                                <hr class="m-0" />
                                <table class="table">
                                    <tbody>
                                        <tr>
                                            <td>Grand Total</td>
                                            <th style="text-align: end;"><span id="Summ_GrandTotal"></span></th>
                                        </tr>
                                    </tbody>

                                </table>
                            </div>

                        </div>
                        <!--end::Tables widget 14-->
                    </div>
                    <!--end::Col-->
                </div>


            <div class="row g-5 g-xl-10 mb-5 mb-xl-10" style="margin-right:0px" id="lstOrderAdding">
                <div class="col-xl-12 card card-flush mt-2">
                    <!--begin::Chart Widget 35-->
                    <div class="col-lg-12 row mb-3" style="display: -webkit-box;">



                        <table class="table mb-0">
                            <thead>
                                <tr>
                                    <th style="text-align: center; vertical-align: middle;">
                                        Item
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        H.UOM
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        Price
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        H.Qty
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        L.UOM
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        Price
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        L.Qty
                                    </th>
                                    <th style="text-align: center; vertical-align: middle;">
                                        Total
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <th class="pb-0 col-lg-3">
                                        @(Html.Kendo().MultiColumnComboBox()
    .Name("Items")
    .Placeholder("Select Item")
    .DataTextField("itmName")
    .DataValueField("itmID")
    .Filter("contains")
    .FilterFields(new string[] { "itmCode", "itmName" })
    .Columns(columns =>
    {
        columns.Add().Field("itmCode").Title("Code").Width(100);
        columns.Add().Field("itmName").Title("Name").Width(500);
    })
    .HtmlAttributes(new { style = "width: 100% ", @class = "form-control", @tabindex = "5"})
    .DataSource(source => {
        source.Read(read =>
        {
            read.Action("GetItems", "GridOrder");
        });
    })
    .Enable(true)
    .AutoBind(true)
)


                                        <span id="itmError" style="color:red; display:none"> Please choose item </span>

                                        <span id="itmError" style="color:red; display:none"> Please choose item </span>

                                    </th>
                                    <th class="pb-0 col-lg-1" style="text-align: end;">

                                        @(Html.Kendo().MultiColumnComboBox()
                      .Name("HUOM")
                      .Placeholder("Select H.UOM")
                      .DataTextField("uomName")
                      .DataValueField("uomID")
                      .Filter("contains")
                       .FilterFields(new string[] { "uomName", "UPC" })
                       .Columns(columns =>
                       {
                           columns.Add().Field("uomName").Title("UOM");
                           columns.Add().Field("UPC").Title("UPC");
                       })
                       .HtmlAttributes(new { @class = "form-control", @tabindex = "6" })
                      .DataSource(source => {
                          source.Read(read =>
                          {
                              read.Action("getUOM", "GridOrder").Data("h_UOMFilter");
                          }).ServerFiltering(true);
                      })
                       .Enable(true)
                      .AutoBind(false)
                      .CascadeFrom("Items")
                      .Events(e =>
            {
                e.Change("on_HUOM_Change");
            })
                )
                                        <span id="HuomError" style="color:red; display:none"> Please choose H.UOM </span>
                                    </th>
                                    <th class="pb-0" style="text-align: center; vertical-align: middle;">
                                        <span style="color:green" id="H_Offer_Price">0.00</span>  <del>
                                            <span style="color:red" id="H_Std_Price"></span>
                                        </del>
                                    </th>
                                    <th class="pb-0 col-lg-1" style="text-align: end;">

                                        @(Html.Kendo().NumericTextBox<int>()
            .Name("HQty")
            .Format("#")
            .Placeholder("Enter Qty")
            .Min(0)
            .Max(2000)
            .Events(e => e
             .Change("CalcTotPrice")
             .Spin("CalcTotPrice") )
            .HtmlAttributes(new {  title = "numeric", @tabindex = "7", @class = "form-control", @AutoComplete = "off" })
      )
                                        <span id="HQtyError" style="color:red; display:none"> Please enter H.Qty </span>
                                    </th>

                                    <th class="pb-0 col-lg-1" style="text-align: end;">
                                        @(Html.Kendo().MultiColumnComboBox()
                      .Name("LUOM")
                      .Placeholder("Select L.UOM")
                      .DataTextField("uomName")
                      .DataValueField("uomID")
                      .Filter("contains")
                       .FilterFields(new string[] { "uomName", "UPC" })
                       .Columns(columns =>
                       {
                           columns.Add().Field("uomName").Title("UOM");
                           columns.Add().Field("UPC").Title("UPC");
                       })
                       .HtmlAttributes(new { @class = "form-control", @tabindex = "8" })
                      .DataSource(source => {
                          source.Read(read =>
                          {
                              read.Action("getLUOM", "Order").Data("l_UOMFilter");
                          }).ServerFiltering(true);
                      })
                       .Enable(true)
                      .AutoBind(false)
                      .CascadeFrom("HUOM")
                      .Events(e =>
                      {
                          e.Change("on_L_UOM_Change");
                      })
                )
                                    </th>
                                    <th class="pb-0 col-lg-1" style="text-align: center; vertical-align: middle;">
                                        <span style="color:green" id="L_Offer_Price">0.00</span>
                                        <del><span style="color:red" id="L_Std_Price"></span> </del>
                                    </th>
                                    <th class="pb-0 col-lg-1" style="text-align: end;">

                                        @(Html.Kendo().NumericTextBox<int>()
                                         .Name("LQty")
                                         .Format("#")
                                         .Placeholder("Enter Qty")
                                         .Min(0)
                                         .Max(2000)
                                           .Events(e => e
             .Change("CalcTotPrice")
             .Spin("CalcTotPrice"))
                                          .HtmlAttributes(new {  title = "numeric" ,  @tabindex = "9", @class = "form-control", @AutoComplete = "off" })

                                        )

                                    </th>
                                    <th class="pb-0" style="text-align: center; vertical-align:middle; "> <span style="color:green" id="TotalPrice">0.00</span></th>
                                    <th class="pb-0 col-lg-1" style="text-align: end;">
                                        <a href="#" onclick="AddItem()" class="btn btn-sm fw-bold btn-primary" tabindex="10">Add Item</a>
                                        <img id="loaderAdd" style="display: none;" class="text-center" src="../Content/media/icons/loader.gif" height="38" />
                                    </th>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="row g-5 g-xl-10 mb-5 mb-xl-10" style="margin-right:0px" id="lstOrderListing">
                <div class="col-xl-12 card card-flush mt-2">
                    <div id="listPartial" class="col-lg-12 mt-5 mb-5">
                        @{
                            Html.RenderPartial("ListOrder");
                        }
                    </div>
                </div>
            </div>

            <div class="row g-5 g-xl-10 mb-5 mb-xl-10" style="margin-right:0px; display:none" id="fg_Actions">

                <div class="col-xl-12 card card-flush mt-2">
                    <div class="d-flex align-items-center gap-2 gap-lg-3 mt-5" style="align-self:flex-end; ">
                        <a href="#" onclick="Show_fg_back_popup()" class="btn btn-outline btn-sm  " style="outline:auto !important; ">Back</a>
                        <a href="#" class="btn btn-sm fw-bold btn-primary" id="btnNext" data-backdrop="static" data-keyboard="false" onclick="NextFreeGood()">
                            Next
                        </a>
                    </div>
                    <div id="lstFreeGood" class="col-lg-12 mt-5 mb-5">
                    </div>

                </div>
            </div>
        </div>
        <!--end::Content container-->
    </div>
    <!--end::Content-->
</div>
@{
    Html.RenderPartial("ProceedBack");
    Html.RenderPartial("ProceedOrder");
    Html.RenderPartial("SuccessOrder");
}

<script>

    window.onload = function () {
          $.ajax({
                type: "GET",
                url: '@Url.Action("getCusCrTerms", "GridOrder")',
                contentType: "application/json; charset=utf-8",
             dataType: "json",
              success: function (data) {
                  $('#PayType').text(data.cusType);
                  $('#CreditDays').text(data.crDays);
                  $('#TotCredLimit').text(data.TotalCr);
                  $('#UsedCredLimit').text(data.UsedCr);
                  $('#AvCreditLimit').text(data.AvlCr);
             }
          });
    };

  function onRepeatChange() {
    ordID = $("#PreviousOrders").val();

    $.ajax({
        type: "GET",
        url: '@Url.Action("updateRepeatOrder", "GridOrder")',
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        data: {
            "ordID": ordID
        },
        success: function (data) {
            if (data.res == "0") {

                $('#listPartial').load('/GridOrder/ShowList');

                $("#Items").data("kendoMultiColumnComboBox").input.val("");
                $("#LUOM").data("kendoMultiColumnComboBox").input.val("");
                $("#HUOM").data("kendoMultiColumnComboBox").input.val("");
                $("#HQty").data("kendoNumericTextBox").value("")
                $("#LQty").data("kendoNumericTextBox").value("");

                $("#Items").val("");
                $("#HUOM").val("");
                $("#LUOM").val("");

                var ddlItems = $("#Items").data("kendoMultiColumnComboBox");
                ddlItems.dataSource.read();
                $("#Items").focus();

                ShowSummary();
               

            } else {
                $('#grvItems').data('kendoGrid').dataSource.data([]);

                $.ajax({
                    type: "POST",
                    url: '/GridOrder/ClearDtItems',
                    success: function (data) {

                        if (data.success) {
                            console.log("dtItems cleared successfully");
                        } else {
                            console.error("Failed to clear dtItems");
                        }
                    },
                    error: function (error) {

                        console.error("Error clearing dtItems:", error);
                    }
                });
               
            // toastr.error('There are already items in the list, please remove them and try again');
            }
        }
    });
}



    function NextFreeGood() {


        var values = new Array();
        var AllID = document.getElementById("itmIds").innerHTML;
        const listArray = AllID.split('-');
        var totQty = 0;
        for (let i = 0; i < listArray.length; i++) {
            var id = listArray[i].toString();
            id = id.replace(" ", "");
            if (id != "") {
                var qty = $("#fg_Qty_" + id).val();


                if (parseInt(qty) > 0) {
                    totQty = totQty + parseInt(qty);

                    values.push({
                        itmID: id,
                        Qty: parseInt(qty)
                    });
                }
            }
        }



        var elgQty = document.getElementById("elg_Qty").innerHTML;

        if (totQty == elgQty) {

             $.ajax({
                type: "POST",
                url: '@Url.Action("FindNextPromo", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                 dataType: "json",
                 data: JSON.stringify({ values }),
                 success: function (data) {
                     if (data.nextEnable == "0") {
                         $("#btnNext").text('Proceed');
                     } else {
                         $("#btnNext").text('Next');
                     }

                  if (data.mode == "P") {
                      $('#lstFreeGood').load('/Order/ShowFreeGood', { csID: cusID });
                  } else {

                      $('#modal_ord_proceed_popup').modal('show');
                  }
                }
            });

        } else {
            alert('The eligible qty (' + elgQty + ') and entered qty (' + totQty + ')should be same');
        }

    }

    function Show_fg_back_popup() {
        $('#modal_fg_back_popup').modal('show');
    }

    function Handle_fg_Back() {
        $('#lstOrderAdding').show('slow');
        $('#lstOrderListing').show('slow');
        $('#fg_Actions').hide('slow');
        $('#btnNext').show();
        $("#btnNext").text('Next');
        $('#btnProceed').show();
        $('#modal_fg_back_popup').modal('hide');
    }

    function CreateOrder() {
        $('#loaderFG').show('slow');
        $('#cusError').hide();
        $('#dateError').hide();
        $('#slotError').hide();

        expDelDate = $("#dspDate").val();
        cusID = $("#Customers").val();




        if (cusID == "") {
            $('#cusError').show();
        } else if (expDelDate == "") {

            $('#dateError').show();
        } else {

                $.ajax({
                type: "GET",
                url: '@Url.Action("getItemCount", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    data: {
                        "cusID": cusID,
                    },
              success: function (data) {
                  if (data.res == "1") {
                      if (data.PrmCount == 0) {
                          //IN PROCEEDORDER VIEW
                          $('#modal_ord_proceed_popup').modal('show');
                      } else {
                          $('#btnProceed').hide();
                          $('#lstOrderAdding').hide('slow');
                          $('#lstOrderListing').hide('slow');
                          $('#fg_Actions').show('slow');
                          $('#lstFreeGood').load('/Order/ShowFreeGood', { csID: cusID });
                      }
                  } else {
                      toastr.error('You must add atleast one item to place an order');
                  }
                }
            });


        }
        $('#loaderFG').hide('slow');
    }


    function ShowSummary() {
         $.ajax({
                type: "GET",
                url: '@Url.Action("getSummary", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                dataType: "json",
              success: function (data) {

                  document.getElementById("Summ_Total").innerHTML = data.Total;
                  document.getElementById("Summ_Discount").innerHTML = data.Discount;
                  document.getElementById("Summ_SubTotal").innerHTML = data.SubTotal;
                  document.getElementById("Summ_VAT").innerHTML = data.VAT;
                  document.getElementById("Summ_GrandTotal").innerHTML = data.GrandTotal;

                }
            });
    }



    function AddItem() {
        $('#loaderAdd').show('slow')
        $('#cusError').hide();
        $('#itmError').hide();
        $('#HuomError').hide();
        $('#HQtyError').hide();

        itmID = $("#Items").val();
        HuomID = $("#HUOM").val();
        LuomID = $("#LUOM").val();

        var h_Qty = $("#HQty").data("kendoNumericTextBox").value();
        var l_Qty = $("#LQty").data("kendoNumericTextBox").value();

        if (itmID == "") {
            $('#itmError').show('slow')
            $('#loaderAdd').hide('slow')
        } else if (HuomID == "") {
            $('#HuomError').show('slow')
            $('#loaderAdd').hide('slow')

        } else if (h_Qty == "") {
            $('#HQtyError').show('slow')
            $('#loaderAdd').hide('slow')
        }
        else {
            $('#itmError').hide('slow');
            $('#HuomError').hide('slow');
            $('#HQtyError').hide('slow');
               $.ajax({
                type: "GET",
                url: '@Url.Action("AddItem", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "itmID": itmID,
                    "H_uom_ID": HuomID,
                    "H_Qty": h_Qty,
                    "L_uom_ID": LuomID,
                    "L_Qty": l_Qty
                },
             dataType: "json",
             success: function (data) {
                 if (data.res == "0") {

                     $('#listPartial').load('/GridOrder/ShowList');

                     $("#Items").data("kendoMultiColumnComboBox").input.val("");
                     $("#LUOM").data("kendoMultiColumnComboBox").input.val("");
                     $("#HUOM").data("kendoMultiColumnComboBox").input.val("");
                     $("#HQty").data("kendoNumericTextBox").value("");
                     $("#LQty").data("kendoNumericTextBox").value("");

                     $("#Items").val("");
                     $("#HUOM").val("");
                     $("#LUOM").val("");

                     var ddlItems = $("#Items").data("kendoMultiColumnComboBox");
                     ddlItems.dataSource.read();
                     $("#Items").focus();

                     ShowSummary();



                     $('#loaderAdd').hide('hide');




                 } else {
                     toastr.error(data.err);
                     $('#loaderAdd').hide('hide');
                 }
             }
               });
        }



    }


    function CalcTotPrice() {
        var H_price = document.getElementById("H_Offer_Price").innerHTML;
        var L_price = document.getElementById("L_Offer_Price").innerHTML;
        var h_Qty = $("#HQty").data("kendoNumericTextBox").value();
        var l_Qty = $("#LQty").data("kendoNumericTextBox").value();
         $.ajax({
                type: "GET",
                url: '@Url.Action("CalcItemTotal", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "H_price": H_price,
                    "L_price": L_price,
                    "h_Qty": h_Qty,
                    "l_Qty": l_Qty
                },
                dataType: "json",
                success: function (data) {

                    document.getElementById("TotalPrice").innerHTML = data.total;
                }
            });
    }

    function on_HUOM_Change() {

        itmID =  $("#Items").val();
        uomID = $("#HUOM").val();
        var huomComboBox = $("#HUOM").data("kendoMultiColumnComboBox");
        var uomDataSource = huomComboBox.dataSource;


        var uomList = [];
        uomDataSource.data().forEach(function (item) {
            uomList.push(item.uomID);
        });

        var lastHUOM = uomList[uomList.length - 1];
        var lQtyInput = $("#LQty").data("kendoNumericTextBox");
        var luomComboBox = $("#LUOM").data("kendoMultiColumnComboBox");

        if (uomID != "" && uomID == lastHUOM) {
            lQtyInput.enable(false);
            luomComboBox.enable(false);

            $.ajax({
                type: "GET",
                url: '@Url.Action("getItmPrice", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                data: {

                    "itmID": itmID,
                    "uomID": uomID
                },
                dataType: "json",
                success: function (data) {

                    document.getElementById("H_Offer_Price").innerHTML = data[0].OfferPrice;
                    document.getElementById("H_Std_Price").innerHTML = data[0].StandardPrice;
                }
            });

        } else {
            document.getElementById("H_Offer_Price").innerHTML = "0.00";
            document.getElementById("H_Std_Price").innerHTML = "";
            document.getElementById("L_Offer_Price").innerHTML = "0.00";
            document.getElementById("L_Std_Price").innerHTML = "";
            $("#LQty").data("kendoNumericTextBox").value("");
            $("#HQty").data("kendoNumericTextBox").value("");
            lQtyInput.enable(true);
            luomComboBox.enable(true);

        }
        CalcTotPrice();

    }


    function on_L_UOM_Change() {
        cusID =  $("#Customers").val();
        itmID =  $("#Items").val();
        uomID = $("#LUOM").val();
        if (uomID != "") {
              $.ajax({
                type: "GET",
                url: '@Url.Action("getItmPrice", "GridOrder")',
                contentType: "application/json; charset=utf-8",
                data: {
                    "cusID": cusID,
                    "itmID": itmID,
                    "uomID": uomID
                },
                dataType: "json",
              success: function (data) {

                  document.getElementById("L_Offer_Price").innerHTML = data[0].OfferPrice;
                  document.getElementById("L_Std_Price").innerHTML = data[0].StandardPrice;
                }
            });
        } else {
            document.getElementById("L_Offer_Price").innerHTML = "0.00";
            document.getElementById("L_Std_Price").innerHTML = "";
            $("#LQty").data("kendoNumericTextBox").value("");
        }
        CalcTotPrice();
    }



    function h_UOMFilter() {
        return {
            itmID: $("#Items").val(),
            uomName: $("#HUOM").data("kendoMultiColumnComboBox").input.val()
        };
    }

    function l_UOMFilter() {
        return {
            itmID: $("#Items").val(),
            H_uom_ID: $("#HUOM").val(),
            uomName: $("#LUOM").data("kendoMultiColumnComboBox").input.val()
        };
    }

    function error_handler(e) {
        if (e.errors) {
            var message = "Errors:\n";
            $.each(e.errors, function (key, value) {
                if ('errors' in value) {
                    $.each(value.errors, function () {
                        message += this + "\n";
                    });
                }
            });
            alert(message);
        }
    }

    function returnFalse() {
        return false;
    }


    $(document).ready(function () {
        var cmbBox = $("#Customers").data('kendoComboBox');
        $("#Customers").focus();

    });

    function Cusfilter() {
        return {
            cusID: $("#Customers").val(),
            slot: $("#TimeSlot").data("kendoComboBox").input.val()
        };
    }



    function RepeatOrder() {
        return {
            ordID: $("#PreviousOrders").data("kendoMultiColumnComboBox").input.val()
        };
    }

    function CusItems() {
        return {
            itemName: $("#Items").data("kendoMultiColumnComboBox").input.val()
        };
    }



    toastr.options = {
        "closeButton": false,
        "debug": false,
        "newestOnTop": true,
        "progressBar": true,
        "positionClass": "toast-bottom-right position-fixed top-0 end-0 p-3 z-index-3",
        "preventDuplicates": true,
        "onclick": null,
        "showDuration": "300",
        "hideDuration": "1000",
        "timeOut": "5000",
        "extendedTimeOut": "1000",
        "showEasing": "swing",
        "hideEasing": "linear",
        "showMethod": "fadeIn",
        "hideMethod": "fadeOut"
    };

    //CusChange function
    function CusChange() {
        const repeatRadio = document.getElementById('repeat');
        const previousOrdersComboBox = $("#PreviousOrders").data("kendoMultiColumnComboBox");
        const dropdownTitle = document.getElementById('dropdownTitle');
       
        $("#Items").data("kendoMultiColumnComboBox").input.val("");
        $("#LUOM").data("kendoMultiColumnComboBox").input.val("");
        $("#HUOM").data("kendoMultiColumnComboBox").input.val("");
        $("#HQty").data("kendoNumericTextBox").value("")
        $("#LQty").data("kendoNumericTextBox").value("");

        $("#Items").val("");
        $("#HUOM").val("");
        $("#LUOM").val("");

        var ddlItems = $("#Items").data("kendoMultiColumnComboBox");
        ddlItems.dataSource.read();

        document.getElementById("H_Offer_Price").innerHTML = "0.00";
        document.getElementById("H_Std_Price").innerHTML = "";
        document.getElementById("L_Offer_Price").innerHTML = "0.00";
        document.getElementById("L_Std_Price").innerHTML = "";
        document.getElementById("L_Offer_Price").innerHTML = "0.00";
        document.getElementById("L_Std_Price").innerHTML = "";

        $("#LQty").data("kendoNumericTextBox").value("");
        $("#HQty").data("kendoNumericTextBox").value("");


        if (repeatRadio.checked) {

            previousOrdersComboBox.wrapper.show();
            previousOrdersComboBox.enable(true);
            previousOrdersComboBox.open();
            //dropdownTitle.style.display = "block";


            $('#grvItems').data('kendoGrid').dataSource.data([]);


            $.ajax({
                type: "POST",
                url: '/GridOrder/ClearDtItems',
                success: function (data) {

                    if (data.success) {
                        console.log("dtItems cleared successfully");
                    } else {
                        console.error("Failed to clear dtItems");
                    }
                },
                error: function (error) {

                    console.error("Error clearing dtItems:", error);
                }
            });
        } else {

            
            $('#grvItems').data('kendoGrid').dataSource.data([]);
            previousOrdersComboBox.enable(false);
            $("#PreviousOrders").data("kendoMultiColumnComboBox").input.val("");
            previousOrdersComboBox.dataSource.read();

            $.ajax({
                type: "POST",
                url: '/GridOrder/ClearDtItems',
                success: function (data) {

                    if (data.success) {
                        console.log("dtItems cleared successfully");
                    } else {
                        console.error("Failed to clear dtItems");
                    }
                },
                error: function (error) {

                    console.error("Error clearing dtItems:", error);
                }
            });


            
        }
    }


    $(document).ready(function () {
        $("#files").kendoUpload({
            "multiple": false
        });
        const previousOrdersComboBox = $("#PreviousOrders").data("kendoMultiColumnComboBox");
        //previousOrdersComboBox.wrapper.hide();
        previousOrdersComboBox.enable(false);
    });

    
</script>